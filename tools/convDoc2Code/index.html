<html>
<head>
    <meta charset="utf-8"/>

    <title>設計書からコード生成するよっ！</title>

    <style>
    .break{
        display: block;
    }
    .wide-textarea{
        width: 100%;
        height: 30vh;
    }
    </style>
</head>

<body>

    

    <div>
        <label class="break">
            機能ID:
            <input id="doc-funcid" />
        </label>

        <label>
            設計書項目定義:
            <textarea id="doc-text" class="wide-textarea"></textarea>
        </label>
    </div>

    <div>
        <button id="exec">変換！</button>
    </div>

    <div>
        <label>
            生成されたソース
            <textarea id="code-text" class="wide-textarea"></textarea>
        </label>
    </div>

<script>

    document.addEventListener("DOMContentLoaded", function(){

        document.getElementById("exec").addEventListener("click", function(){

            const funcId = document.getElementById("doc-funcid").value
            const inputText = document.getElementById("doc-text").value

            if(!funcId || !inputText) return

            const rows = inputText.split("\n")

            if(!rows) return

            const SOURCE_TEMPLATE = `
import React from 'react'
import PropTypes from "prop-types"
import Grid from '@material-ui/core/Grid'
import Paper from '@material-ui/core/Paper'
import HznButton from "../commons/HznButton"
import FieldItem from "../commons/FieldItem"
import {
    INPUT_FIELD_TYPE_TEXT,
    INPUT_FIELD_TYPE_SELECT,
    INPUT_FIELD_TYPE_CHECKBOX,
    INPUT_FIELD_TYPE_CHECKBOXES,
    INPUT_FIELD_TYPE_RADIO,
    INPUT_FIELD_TYPE_BUTTON,
    OUTPUT_FIELD_TYPE_TEXT
} from "../../constants/common"
import {
    showAlertMsg,
    onTextChange,
    onSelectChange,
    onRadioChange,
} from "../../utils/CommonUtils"

export default class ___FUNC_ID___ extends React.Component{

    static contextTypes = {
        router: PropTypes.object
    }

    constructor(props){

        super(props)

        this.state = {
___STATE_DEFS___
        }

        this.onHznClick = this.onHznClick.bind(this)
        this.onTextChange = onTextChange(this)
        this.onSelectChange = onSelectChange(this)
        this.onRadioChange = onRadioChange(this)
        this.TODO_YOU_DEFINE_SOMETHING = function(){} // TODO: 

        this.itemDef = [
___ITEM_DEFS___
        ]
    }

    // TODO: 
    TODO_YOU_DEFINE_SOMETHING(){

    }

    onHznClick(){

		// TODO: 

    }

    render(){

        return (
            <div className="___FUNC_ID___-wrapper inner-wrapper">
                <Paper className="input-items-wrapper">
                {
                    this.itemDef.map((v, i)=> (<FieldItem key={i} {...v} xs={12} md={4} value={this.state[v.id]} />))
                }
                </Paper>

                <Grid item xs={12} className="footer-butons">
                    <HznButton text="確認" onClick={this.onHznClick} />
                </Grid>
                
            </div>
        )
    }

}
`

            const COL_NUM = 10
            const DELIMITER = "::::"
            const IDX_LOGICAL_NAME = 2
            const IDX_INPUT_TYPE = 3
            const IDX_VALIDATION = 6
            const IDX_NAME = 8
            const IDX_SELECTION = 9
            const INDENT_FOR_ITEM_DEF = "\t\t\t"
            const INDENT_FOR_STATE_DEF = "\t\t\t"

            const INPUT_TYPE_MAPPER = {
                "入力": "INPUT_FIELD_TYPE_TEXT",
                "選択(リスト)": "INPUT_FIELD_TYPE_SELECT",
                "チェックボックス": "INPUT_FIELD_TYPE_CHECKBOX",
                "選択(ラジオ)": "INPUT_FIELD_TYPE_RADIO",
                "ボタン": "INPUT_FIELD_TYPE_BUTTON",
                "表示": "OUTPUT_FIELD_TYPE_TEXT"
            }
            const EVENT_HANDLER_MAPPER = {
                INPUT_FIELD_TYPE_TEXT: "onTextChange",
                INPUT_FIELD_TYPE_SELECT: "onSelectChange",
                INPUT_FIELD_TYPE_CHECKBOX: "onCheckboxChange",
                INPUT_FIELD_TYPE_RADIO: "onRadioChange",
                INPUT_FIELD_TYPE_BUTTON: "TODO_YOU_DEFINE_SOMETHING"
            }

            const getArr = nums=> [...Array(nums).keys()]
            const regstr = "^" + getArr(COL_NUM).map(v=> "(.*?)").join("\t") + "$"
            const regExp = new RegExp(regstr)
            const replacedStr = getArr(COL_NUM).map((v, i)=> "$" + (i + 1)).join(DELIMITER)

            const itemDefs = rows
                .map(v=> {
                    const row = v.replace(regExp, replacedStr).split(DELIMITER)

                    const type = INPUT_TYPE_MAPPER[row[IDX_INPUT_TYPE]]
                    const name = (row[IDX_NAME] || "").replace(/\n/g, " ")
                    const logicalName = row[IDX_LOGICAL_NAME]
                    const eventHandler = EVENT_HANDLER_MAPPER[type]
                    const selection = (()=> {
                        const selectionStr = row[IDX_SELECTION]

                        if(!selectionStr){ return null   } 

                        const resArr = selectionStr
                            .split(",")
                            .map((s, i)=> {
                                return {
                                    value: "" + i,
                                    label: "" + (s || "").replace(/\s/g, "")
                                }
                            })
                        return resArr
                    })()

                    const resStr = `${INDENT_FOR_ITEM_DEF}{ type: ${type}, id: "${name}", label: "${logicalName}"`
                         + (!!eventHandler ? `, onChange: this.${eventHandler}("${name}")` : "") 
                         + (!!selection ? `, \n${INDENT_FOR_ITEM_DEF}\titems: ${JSON.stringify(selection)}\n${INDENT_FOR_ITEM_DEF}` : "")
                         + "},"

                    return resStr

                    //return `${INDENT_FOR_ITEM_DEF}{ type: ${type}, id: "${name}", label: "${logicalName}", onChange: this.${eventHandler}("${name}") },`

                })

            const stateDefs = rows
                .map(v=> {
                    const row = v.replace(regExp, replacedStr).split(DELIMITER)
                    const type = INPUT_TYPE_MAPPER[row[IDX_INPUT_TYPE]]
                    const name = row[IDX_NAME]

                    return (!name ? "//" : "") + `${INDENT_FOR_STATE_DEF}${name}: "",`
                })

            const res = SOURCE_TEMPLATE
                .replace(/___FUNC_ID___/g, funcId)
                .replace("___ITEM_DEFS___", itemDefs.join("\n"))
                .replace("___STATE_DEFS___", stateDefs.join("\n"))

            document.getElementById("code-text").value = res


console.log(regExp, itemDefs, stateDefs)


            

        })
        
    })

</script>

</body>

</html>